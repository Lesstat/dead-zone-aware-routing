<!DOCTYPE html>
<html>
  <head>
    
    <title>Flos Fapra</title>
    
    <link href="leaflet/leaflet.css" rel="stylesheet" type="text/css" />
    <script src="leaflet/leaflet.js"> </script>

  </head>
    
  <body> 
    
    <div style="float:left; width: 300px;">
      Start ID: <span id="start"></span> <br />
      End ID: <span id="end"></span><br />
      Distance: <span id="dist">0</span> km <br />
      Travel Time: <span id="time">0</span> h<br />
      Routing: <br />
      Short<input type="radio" name="goal" value="length" checked="checked" onclick="calc_dist()">
      Fast<input type="radio" name="goal" value="speed"   onclick="calc_dist()">
      <br />
      Car<input type="radio" name="move" value="car"  checked="checked" onclick="calc_dist()">
      Foot<input type="radio" name="move" value="foot"   onclick="calc_dist()">
    </div>
    <div id="mapid" style="width: 80%; height: 800px;"></div>
    <script>
     
     var map = L.map('mapid', { closePopupOnClick: false}).setView([48.7456643, 9.1070856], 15);
     var start = true;

     var startPopup = L.popup({ autoClose: false });
     var endPopup = L.popup({ autoClose: false });
     var geoJson = L.geoJSON().addTo(map);
     
     L.tileLayer('http://{s}.tile.openstreetmap.org/{id}/{z}/{x}/{y}.png', {
       maxZoom: 18,
       attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
		    '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ',
       id: ''
     }).addTo(map);
     
      function onMapClick(e) {
	var id;
	if (start){
	  id = "start";
	  startPopup.setLatLng(e.latlng).setContent("Start at " + e.latlng.toString()).addTo(map);
	} else{
	  id = "end"
	  endPopup.setLatLng(e.latlng).setContent("End at " + e.latlng.toString()).addTo(map);
	}
	start = !start;
	get_node(id, e.latlng) ;
     }

     
     map.on('click', onMapClick);
     
     function get_node(id, latlng){
       
       var xmlhttp = new XMLHttpRequest();
       
       xmlhttp.onload = function() {
	 if (xmlhttp.status == 200) {
	     document.getElementById(id).innerHTML = xmlhttp.responseText;
	     calc_dist();
	   }
       };
       xmlhttp.open("GET", "node_at?lat="+ latlng.lat  + "&long=" + latlng.lng, true);
       xmlhttp.send();
     }

     function calc_dist(){
       
       var xmlhttp = new XMLHttpRequest();
       
       xmlhttp.responseType = 'json';
       xmlhttp.onload = function() {
	 if (xmlhttp.status == 200) {
	     var myStyle = {
	       "color": "#ff7800",
	       "weight": 5,
	       "opacity": 0.65
	     };
	     document.getElementById("dist").innerHTML = xmlhttp.response.distance;
	     document.getElementById("time").innerHTML = xmlhttp.response.travel_time;
	     map.removeLayer(geoJson);
	     geoJson = L.geoJSON(xmlhttp.response.route.geometry, { style: myStyle }).addTo(map);
	   }
	   else {
	     document.getElementById("dist").innerHTML = "Unkown";
	   }
       };
       var goal = document.querySelector('input[name="goal"]:checked').value;
       var move = document.querySelector('input[name="move"]:checked').value;
       var s = document.getElementById("start").innerHTML;
       var t = document.getElementById("end").innerHTML;
       xmlhttp.open("GET", "route?s="+ s  + "&t=" + t+ "&goal=" + goal + "&move=" + move, true);
       xmlhttp.send();
     }
    </script>
    
    
  </body>
  
  
</html>
